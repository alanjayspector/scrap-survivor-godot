#!/bin/bash
# Pre-commit hook for Godot project

echo "üîç Running pre-commit checks..."
echo "üí° Tip: See docs/godot-community-research.md for best practices and common issues"
echo ""

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

VALIDATION_FAILED=0

# Get staged .gd files
STAGED_GD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.gd$' || true)

if [ -z "$STAGED_GD_FILES" ]; then
    echo "No GDScript files to check"
else
    echo "Checking: $STAGED_GD_FILES"

    # Run gdlint (uses .gdlintrc automatically if present)
    if command -v gdlint &> /dev/null; then
        if ! gdlint $STAGED_GD_FILES; then
            echo -e "${RED}‚ùå Linting failed${NC}"
            VALIDATION_FAILED=1
        else
            echo -e "${GREEN}‚úÖ Linting passed${NC}"
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è  gdlint not found, skipping${NC}"
    fi

    # Run gdformat check
    if command -v gdformat &> /dev/null; then
        FILES_TO_FORMAT=$(gdformat --check $STAGED_GD_FILES 2>&1 | grep -E "^reformatted|^would reformat" || true)
        if [ "$FILES_TO_FORMAT" != "" ]; then
            echo -e "${RED}‚ùå Formatting failed${NC}"
            echo "Run: gdformat $STAGED_GD_FILES"
            VALIDATION_FAILED=1
        else
            echo -e "${GREEN}‚úÖ Formatting passed${NC}"
        fi
    fi
fi

# Run additional validators (always, even if no .gd files changed)
echo ""
echo "üîé Running project validators..."

# Native class name checker (BLOCKING - Week 6 Day 1)
if [ -f .system/validators/native_class_checker.py ]; then
    if ! python3 .system/validators/native_class_checker.py; then
        VALIDATION_FAILED=1
    fi
fi

# Service API consistency checker (BLOCKING - Week 6 Day 2)
if [ -f .system/validators/service_api_checker.py ]; then
    if ! python3 .system/validators/service_api_checker.py; then
        VALIDATION_FAILED=1
    fi
fi

# Test method validator (BLOCKING - Week 6 Day 3)
if [ -f .system/validators/test_method_validator.py ]; then
    if ! python3 .system/validators/test_method_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Integration test requirement checker (non-blocking reminder - Week 6 Day 3)
if [ -f .system/validators/integration_test_checker.py ]; then
    python3 .system/validators/integration_test_checker.py
fi

# User story validator (non-blocking reminder - Week 6 Day 3)
if [ -f .system/validators/user_story_validator.py ]; then
    python3 .system/validators/user_story_validator.py
fi

# Test naming convention validator (non-blocking warning)
if [ -f .system/validators/test_naming_validator.py ]; then
    python3 .system/validators/test_naming_validator.py
fi

# Godot configuration validator
if [ -f .system/validators/godot_config_validator.py ]; then
    if ! python3 .system/validators/godot_config_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Resource validator
if [ -f .system/validators/resource_validator.py ]; then
    if ! python3 .system/validators/resource_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Documentation validator
if [ -f .system/validators/documentation_validator.py ]; then
    if ! python3 .system/validators/documentation_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Godot anti-patterns validator (community best practices - Week 6 Day 4)
if [ -f .system/validators/godot_antipatterns_validator.py ]; then
    if ! python3 .system/validators/godot_antipatterns_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Godot performance validator (performance patterns - Week 6 Day 4)
if [ -f .system/validators/godot_performance_validator.py ]; then
    if ! python3 .system/validators/godot_performance_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Service architecture validator (service patterns - Week 6 Day 5)
if [ -f .system/validators/service_architecture_validator.py ]; then
    if ! python3 .system/validators/service_architecture_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Test patterns validator (testing patterns - Week 6 Day 5 - NON-BLOCKING)
if [ -f .system/validators/test_patterns_validator.py ]; then
    python3 .system/validators/test_patterns_validator.py
    # Don't fail on warnings - this is informational for GUT migration
fi

# Godot runtime validator (DISABLED - needs better strategy)
# if [ -f .system/validators/godot_runtime_validator.py ]; then
#     if ! python3 .system/validators/godot_runtime_validator.py; then
#         VALIDATION_FAILED=1
#     fi
# fi

# Godot test runner (runs tests in headless mode)
if [ -f .system/validators/godot_test_runner.py ]; then
    if ! python3 .system/validators/godot_test_runner.py; then
        VALIDATION_FAILED=1
    fi
fi

# Final check
if [ $VALIDATION_FAILED -ne 0 ]; then
    echo ""
    echo -e "${RED}‚ùå Validation failed - fix errors above${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}‚úÖ All checks passed${NC}"
