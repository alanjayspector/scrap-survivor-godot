#!/bin/bash
# Pre-commit hook for Godot project

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

# ============================================================================
# CLAUDE RULES ENFORCEMENT (Defense-in-depth)
# ============================================================================
# This section enforces .system/CLAUDE_RULES.md for AI-assisted commits
# NOTE: This hook CANNOT catch --no-verify flag (it bypasses hooks entirely)
# The git-wrapper.sh script is the first line of defense for that

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo -e "${BOLD}‚ö†Ô∏è  CLAUDE CODE REMINDER${NC}"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

# Check for dangerous git states
IS_AMEND=false
IS_MERGE=false

# Detect amend (comparing proposed commit with HEAD)
if git rev-parse --verify HEAD >/dev/null 2>&1; then
    # Check if this would rewrite HEAD (amend detection)
    if [ -f .git/COMMIT_EDITMSG ]; then
        # If ORIG_HEAD exists and equals HEAD, we might be amending
        if [ -f .git/ORIG_HEAD ]; then
            ORIG_HEAD=$(cat .git/ORIG_HEAD)
            CURRENT_HEAD=$(git rev-parse HEAD)
            if [ "$ORIG_HEAD" = "$CURRENT_HEAD" ]; then
                IS_AMEND=true
            fi
        fi
    fi
fi

# Detect merge commit
if [ -f .git/MERGE_HEAD ]; then
    IS_MERGE=true
fi

# Show status
if [ "$IS_AMEND" = true ]; then
    echo -e "${YELLOW}üö® AMEND DETECTED - Check CLAUDE_RULES.md line 22${NC}"
    echo ""
fi

if [ "$IS_MERGE" = true ]; then
    echo -e "${BLUE}‚ÑπÔ∏è  Merge commit detected${NC}"
    echo ""
fi

# Always show rules reminder for Claude Code sessions
echo "Before committing, verify compliance with:"
echo "  üìã .system/CLAUDE_RULES.md"
echo ""
echo "BANNED FLAGS (will fail if used):"
echo "  ‚ùå --no-verify  (bypasses this hook - use git-wrapper.sh to catch)"
echo "  ‚ùå --amend      (detected above if present)"
echo "  ‚ùå --force      (push only)"
echo "  ‚ùå --skip-ci    (CI bypass)"
echo ""
echo "BLOCKING PROTOCOL (CLAUDE_RULES.md lines 7-24):"
echo "  1. Announce: 'APPROVAL REQUIRED: [action]'"
echo "  2. Show evidence checklist"
echo "  3. Show exact command"
echo "  4. WAIT for user 'yes'"
echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

# If amend detected without explicit approval, provide extra warning
if [ "$IS_AMEND" = true ]; then
    echo -e "${RED}${BOLD}WARNING: Amend detected!${NC}"
    echo "  - Check authorship: git log -1 --format='%an %ae'"
    echo "  - Ensure commit not pushed: git status"
    echo "  - CLAUDE: Did you get explicit user approval?"
    echo ""

    # Show current commit author
    AUTHOR=$(git log -1 --format='%an <%ae>' 2>/dev/null || echo "No commits yet")
    echo "  Current HEAD author: $AUTHOR"
    echo ""

    # Pause for 2 seconds to ensure Claude/user sees this
    echo "Continuing in 3 seconds (Ctrl+C to abort)..."
    sleep 3
    echo ""
fi

# ============================================================================
# Empty Commit Detection (Week 16 - Process Improvement)
# ============================================================================
# Prevent commits with no staged changes (except merges)
if git diff --cached --quiet && [ "$IS_MERGE" = false ]; then
    echo -e "${RED}‚ùå ERROR: Attempting to create empty commit${NC}"
    echo "   No files staged for commit"
    echo ""
    echo "   This check prevents commits where work is claimed but no changes exist."
    echo "   If you need an empty commit (rare), use: git commit --allow-empty"
    exit 1
fi

# ============================================================================
# Standard validation checks
# ============================================================================
echo "üîç Running pre-commit checks..."
echo "üí° Tip: See docs/godot-community-research.md for best practices and common issues"
echo ""

VALIDATION_FAILED=0

# Get staged .gd files (excluding addons/)
STAGED_GD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.gd$' | grep -v '^addons/' || true)

if [ -z "$STAGED_GD_FILES" ]; then
    echo "No GDScript files to check"
else
    echo "Checking: $STAGED_GD_FILES"

    # Run gdlint (uses .gdlintrc automatically if present)
    if command -v gdlint &> /dev/null; then
        if ! gdlint $STAGED_GD_FILES; then
            echo -e "${RED}‚ùå Linting failed${NC}"
            VALIDATION_FAILED=1
        else
            echo -e "${GREEN}‚úÖ Linting passed${NC}"
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è  gdlint not found, skipping${NC}"
    fi

    # Run gdformat (auto-fix and stage changes)
    if command -v gdformat &> /dev/null; then
        # Format files (modifies them in place)
        gdformat $STAGED_GD_FILES > /dev/null 2>&1

        # Check if any files were modified by gdformat
        MODIFIED_FILES=$(git diff --name-only $STAGED_GD_FILES || true)

        if [ -n "$MODIFIED_FILES" ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  gdformat auto-fixed files:${NC}"
            echo "$MODIFIED_FILES" | sed 's/^/  - /'

            # Stage the formatted files
            git add $MODIFIED_FILES
            echo -e "${BLUE}üìù Auto-staged formatting fixes${NC}"
        fi

        # Verify formatting is now correct
        if ! gdformat --check $STAGED_GD_FILES > /dev/null 2>&1; then
            echo -e "${RED}‚ùå Formatting failed after auto-fix${NC}"
            VALIDATION_FAILED=1
        else
            echo -e "${GREEN}‚úÖ Formatting passed${NC}"
        fi
    fi
fi

# Run additional validators (always, even if no .gd files changed)
echo ""
echo "üîé Running project validators..."

# Native class name checker (BLOCKING - Week 6 Day 1)
if [ -f .system/validators/native_class_checker.py ]; then
    if ! python3 .system/validators/native_class_checker.py; then
        VALIDATION_FAILED=1
    fi
fi

# Service API consistency checker (BLOCKING - Week 6 Day 2)
if [ -f .system/validators/service_api_checker.py ]; then
    if ! python3 .system/validators/service_api_checker.py; then
        VALIDATION_FAILED=1
    fi
fi

# Test method validator (BLOCKING - Week 6 Day 3)
if [ -f .system/validators/test_method_validator.py ]; then
    if ! python3 .system/validators/test_method_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Integration test requirement checker (non-blocking reminder - Week 6 Day 3)
if [ -f .system/validators/integration_test_checker.py ]; then
    python3 .system/validators/integration_test_checker.py
fi

# User story validator (non-blocking reminder - Week 6 Day 3)
if [ -f .system/validators/user_story_validator.py ]; then
    python3 .system/validators/user_story_validator.py
fi

# Test naming convention validator (non-blocking warning)
if [ -f .system/validators/test_naming_validator.py ]; then
    python3 .system/validators/test_naming_validator.py
fi

# Godot configuration validator
if [ -f .system/validators/godot_config_validator.py ]; then
    if ! python3 .system/validators/godot_config_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Resource validator
if [ -f .system/validators/resource_validator.py ]; then
    if ! python3 .system/validators/resource_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Scene node path validator (BLOCKING - Week 10 Phase 4)
if [ -f .system/validators/scene_node_path_validator.py ]; then
    if ! python3 .system/validators/scene_node_path_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Scene structure validator (BLOCKING - Week 15 Phase 3 QA Fix)
if [ -f .system/validators/scene_structure_validator.py ]; then
    if ! python3 .system/validators/scene_structure_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Scene instantiation validator (BLOCKING - Week 15 Phase 3 QA Fix)
if [ -f .system/validators/scene_instantiation_validator.py ]; then
    if ! python3 .system/validators/scene_instantiation_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Component usage validator (BLOCKING - Week 15 Phase 3 QA Fix)
if [ -f .system/validators/component_usage_validator.py ]; then
    if ! python3 .system/validators/component_usage_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Refactor verification validator (runs in pre-commit but skips gracefully)
# Full validation happens in commit-msg hook where the message is available
if [ -f .system/validators/refactor_verification_validator.py ]; then
    if ! python3 .system/validators/refactor_verification_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Documentation validator
if [ -f .system/validators/documentation_validator.py ]; then
    if ! python3 .system/validators/documentation_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Godot anti-patterns validator (community best practices - Week 6 Day 4)
if [ -f .system/validators/godot_antipatterns_validator.py ]; then
    if ! python3 .system/validators/godot_antipatterns_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Godot performance validator (performance patterns - Week 6 Day 4)
if [ -f .system/validators/godot_performance_validator.py ]; then
    if ! python3 .system/validators/godot_performance_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Service architecture validator (service patterns - Week 6 Day 5)
if [ -f .system/validators/service_architecture_validator.py ]; then
    if ! python3 .system/validators/service_architecture_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Data model consistency validator (Week 10 Phase 3 - NON-BLOCKING warnings for field name mismatches)
if [ -f .system/validators/data_model_consistency_validator.py ]; then
    python3 .system/validators/data_model_consistency_validator.py
    # Don't fail - this is informational to catch potential typos
fi

# Test patterns validator (testing patterns - Week 6 Day 5 - NON-BLOCKING)
if [ -f .system/validators/test_patterns_validator.py ]; then
    python3 .system/validators/test_patterns_validator.py
    # Don't fail on warnings - this is informational for GUT migration
fi

# Test quality validator (BLOCKING - enforces USER STORY headers and test quality)
if [ -f .system/validators/test_quality_validator.py ]; then
    if ! python3 .system/validators/test_quality_validator.py; then
        VALIDATION_FAILED=1
    fi
fi

# Pattern checker (NON-BLOCKING - checks for common code patterns and issues)
if [ -f .system/validators/check-patterns.sh ]; then
    bash .system/validators/check-patterns.sh
    # Don't fail - this is informational warnings
fi

# Asset import validator (BLOCKING - Week 9)
if [ -f .system/validators/check-imports.sh ]; then
    if ! bash .system/validators/check-imports.sh; then
        VALIDATION_FAILED=1
    fi
fi

# Godot runtime validator (DISABLED - needs better strategy)
# if [ -f .system/validators/godot_runtime_validator.py ]; then
#     if ! python3 .system/validators/godot_runtime_validator.py; then
#         VALIDATION_FAILED=1
#     fi
# fi

# Godot test runner (runs tests in headless mode)
if [ -f .system/validators/godot_test_runner.py ]; then
    if ! python3 .system/validators/godot_test_runner.py; then
        VALIDATION_FAILED=1
    fi
fi

# Final check
if [ $VALIDATION_FAILED -ne 0 ]; then
    echo ""
    echo -e "${RED}‚ùå Validation failed - fix errors above${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}‚úÖ All checks passed${NC}"
