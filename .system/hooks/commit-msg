#!/bin/bash
# Commit message validation

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

PATTERN="^(feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert)(\(.+\))?: .{1,100}"

if ! echo "$COMMIT_MSG" | grep -qE "$PATTERN"; then
    echo "❌ Invalid commit message format"
    echo ""
    echo "Use: <type>[scope]: <description>"
    echo "Example: feat: add enemy spawning"
    exit 1
fi

# Check for "fix" claims with no file changes (Week 16 - Process Improvement)
# This prevents empty commits that claim to fix something
if echo "$COMMIT_MSG" | grep -qiE "^fix"; then
    # Check if there are staged changes
    if git diff --cached --quiet; then
        # Check if this is a merge commit (allowed to be empty)
        if [ ! -f .git/MERGE_HEAD ]; then
            echo "❌ Commit message claims 'fix' but no files are being changed"
            echo ""
            echo "   This prevents empty commits claiming to fix issues."
            echo "   Either stage your changes or use a different commit type."
            exit 1
        fi
    fi
fi

# Refactor verification validator (validates component/refactor claims match reality)
# This is the proper place for this validator - commit message is now available
if [ -f .system/validators/refactor_verification_validator.py ]; then
    if ! python3 .system/validators/refactor_verification_validator.py "$COMMIT_MSG_FILE"; then
        exit 1
    fi
fi
