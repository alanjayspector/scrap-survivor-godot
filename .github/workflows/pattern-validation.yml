name: Pattern Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'scripts/**/*.gd'
      - '.system/validators/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'scripts/**/*.gd'

jobs:
  validate-patterns:
    runs-on: ubuntu-latest
    name: Validate GDScript Patterns

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run pattern validators
        id: patterns
        run: |
          echo "::group::Running pattern validators"

          if [ -f ".system/validators/check-patterns.sh" ]; then
            bash .system/validators/check-patterns.sh || {
              echo "::error::Pattern validation failed"
              exit 1
            }
          else
            echo "::warning::Pattern validator not found - skipping"
          fi

          echo "::endgroup::"

      - name: Check naming conventions
        id: naming
        run: |
          echo "::group::Checking file naming conventions"

          # Check for non-snake_case GDScript files
          BAD_FILES=$(find scripts -name "*.gd" 2>/dev/null | while read file; do
            filename=$(basename "$file" .gd)
            if [[ ! "$filename" =~ ^[a-z][a-z0-9_]*$ ]]; then
              echo "$file"
            fi
          done)

          if [ -n "$BAD_FILES" ]; then
            echo "::error::Found files with invalid naming (must be snake_case):"
            echo "$BAD_FILES"
            exit 1
          else
            echo "✅ All files follow snake_case naming"
          fi

          echo "::endgroup::"

      - name: Check for type hints
        id: types
        run: |
          echo "::group::Checking for type hints"

          # This is a warning-only check
          MISSING_TYPES=$(find scripts -name "*.gd" 2>/dev/null | xargs grep -l "^func " | while read file; do
            if grep "^func " "$file" | grep -v "\->" | grep -v "_ready\(\)" | grep -v "_process\(" | grep -q .; then
              echo "$file"
            fi
          done)

          if [ -n "$MISSING_TYPES" ]; then
            echo "::warning::Files with functions missing return type hints:"
            echo "$MISSING_TYPES"
            echo "::notice::Add '-> ReturnType' to function signatures"
          else
            echo "✅ All functions have type hints"
          fi

          echo "::endgroup::"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Godot anti-patterns
        id: antipatterns
        run: |
          echo "::group::Checking for Godot anti-patterns"

          if [ -f ".system/validators/godot_antipatterns_validator.py" ]; then
            python3 .system/validators/godot_antipatterns_validator.py || {
              echo "::error::Anti-pattern validation failed"
              echo "::notice::See docs/godot-community-research.md for best practices"
              exit 1
            }
          else
            echo "::warning::Anti-pattern validator not found - skipping"
          fi

          echo "::endgroup::"

      - name: Check Godot performance patterns
        id: performance
        run: |
          echo "::group::Checking for Godot performance anti-patterns"

          if [ -f ".system/validators/godot_performance_validator.py" ]; then
            python3 .system/validators/godot_performance_validator.py || {
              echo "::error::Performance validation failed"
              echo "::notice::See docs/godot-performance-patterns.md for optimization strategies"
              exit 1
            }
          else
            echo "::warning::Performance validator not found - skipping"
          fi

          echo "::endgroup::"

      - name: Check service architecture patterns
        id: architecture
        run: |
          echo "::group::Checking for service architecture issues"

          if [ -f ".system/validators/service_architecture_validator.py" ]; then
            python3 .system/validators/service_architecture_validator.py || {
              echo "::error::Service architecture validation failed"
              echo "::notice::See docs/godot-service-architecture.md for patterns and examples"
              exit 1
            }
          else
            echo "::warning::Service architecture validator not found - skipping"
          fi

          echo "::endgroup::"

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pattern-validation-report
          path: |
            .system/logs/
          retention-days: 30
          if-no-files-found: ignore
